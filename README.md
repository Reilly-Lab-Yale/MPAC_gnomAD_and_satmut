These scripts were written by me, Mackenzie Noon (mackenzie.noon@yale.edu) & ChatGPT. Contact me (Mackenzie, that is) with any questions.

## Overview

The goal of this analysis is to .... 

The basic flow:

\[input data\] -> 0. merge -> 1. annotate 2. filter -> 3. count -> 4. graph

(TODO: explain all this once the logic is semi-finalized...)
(this should be changed to a graph instead of a linear flow)

Additionally, manual verification with screenshots...

Additionally, "intuition" ...

Note on filtering: 
- MAF_OR_AC_IS_ZERO : earmarked in ANNOTATE, filtered... 


## How to reproduce 

- In this directory, a yml file is provided which should allow you to make a conda environment that will facilitate recapitulation most results.
- You can see "conda activate mcn_varef" in the batch files used to submit the relevant 
- A few shell scripts use specific versions of SAMtools & BEDtools, as documented in ...
- These scripts uses file generated by other analysis...
    - Uses gnomad VCF annotated with malinois activity predictions ...
    - gnomad from ...
    - malinous activity predictions produced in ...
    - The filtering step used masking produced in ...

Tange, O. (2021, March 22). GNU Parallel 20210322 ('2002-01-06').
  Zenodo. https://doi.org/10.5281/zenodo.4628277
  
  
- according to ...

TODO: fill all this out once completed...

Worflow also includes some shell code, and so uses awk, wc, other similar utilities. 



### note on encoding in count tables
Sometimes presence of variants within a bin is stored in a one-hot fashion : multiple true/false columns, one for each bin. 
This is not generally desirable, so I convert away with "find_true_column"

other times, this is desirable as it is not actually one hot, but multi-hot. Such as presence in genomic region (i.e. some variants might be both in a promoter like sequence & some other cata)

### note on sex chromosomes
gnomad does not include the Y chromosome, so naturally it isn't included ...
to avoid complications, the X chromosome isnt included either. 
- It *is* processed for some of the steps, but the exon file "filter" does not contain it & so we remove around that step ....

...

AF, AC & AN

(from tooltips on gnomad website)

AC : Allele Count : "Alternate allele count in high-quality genotypes"
AN : Allele Number : "Total high quality genotypes"
AF : Allele Frequency : "Alternate Allele Frequency in high quality genotypes"

AF=AC/AN

I define : MAF (minor allele frequency) = min(AF,1-AF)

gnomad filters 1) filter = pass, 2) maf != 0, 3) AN >= 76,156
- 76,156 is [the number of high-quality genomes in 3.1](https://gnomad.broadinstitute.org/news/2020-10-gnomad-v3-1/)
- Therefore, if a site were called in all individuals it would be 76,156\*2 . Gnomad sometimes issues the following warning

> Warning This variant is covered in fewer than 50% of individuals in gnomAD v3.1.2 genomes. This may indicate a low-quality site.

Example : [rs113653250](https://gnomad.broadinstitute.org/variant/1-434284-T-G?dataset=gnomad_r3)

...


- 

We're using gnomad v3.1.2. 

activity ref OR alt:
(-Inf,1), [1,2), [2,4), [4,6), [6,Inf) (note first bin we would call as not active)
- I am worried that this will lose directional effects. I will make separate sets of bins for REF and ALT. 

allelic skew:
(-Inf, -1.5), [-1.5, 1), [-1, -0.5), [-0.5, 0), [0, 0.5), [0.5, 1), [1, 1.5), [1.5, Inf) (note middle two bins we would not call as emvars)

...

## Todo



## broad improvements 
- [x] Add step after annotation that computes pleiotropy, such that it need not be re-computed each time. <- **PRIORITY**
   - [x] Also filter MAF=0 <- **PRIORITY**
- [ ] re-run all existing graphs with new rare/common definition <- **PRIORITY**
- [ ] double check that all graph notebooks are loading the whole data tables with their globs. Otherwise, may read with spark then convert to pandas or introduce csv consolidation step <-  **PRIORITY**
- [ ] Change genomic region plots to clustered bars instead of separate plots. 
- [ ] Prepare track-hub.
    - [ ] Tell YCRC: readable FTP

## general
- [ ] violin plotter
    - [ ] & coresp parameter extracter

## finalization tasks
- [ ] finish writing docs
- [ ] Re-export final conda YML
- [ ] convert `malinois_vs_phylop=malinois_vs_phylop.rename(columns={i:i.replace('^', ',').replace('&','.') for i in malinois_vs_phylop.columns})` to function call in graphing settings file
- [ ] modify all graphs to look nice & export to svg or something
- [ ] move NN E4L9NdjPku1yFLxlZoJtXQ6TaMbewMye to better location
- [ ] move NN BL2jL5SIMor1yx6B21DpQ1jm4oiF82tt to better location
- [ ] If you send a copy of your published article to tange@gnu.org, it will be mentioned in the release notes of next version of GNU Parallel.

## specific graphs

### we have the following summaries of our data:
- malinois skew
- malinois ref activity
- CADD score
- PhyloP score
- ensembl VEP
- allele frequency
- pleiotropy

### We have the following modifiers
- Genomic regions
- For continuious variables we can discretize them or leave them continuious 
    - For AF, we can do AF or rare/common discretizing


### all possible two-variable plots:
malinois skew, malinois ref activity,
- [ ] todo : 2d density plot & line-fitting
malinois skew, CADD score,
- not planned
malinois skew, PhyloP score,
- [ ] todo, violin + difference of means t-test
malinois skew, ensembl VEP,
- not planned
malinois skew, AF,
- [ ] todo, violin & difference of means t-test
malinois skew, pleio,
- [ ] todo, violin & difference of means t-test
malinois ref activity, CADD score,
- Not planned
malinois ref activity, PhyloP score,
- not planned
malinois ref activity, ensembl VEP,
- Not planned
malinois ref activity, AF,
- [ ] todo, violin & difference of means t-test
malinois ref activity, pleio,
- [ ] todo, violin & difference of means t-test
CADD score, PhyloP score,
- not planned
CADD score, ensembl VEP,
- not planned
CADD score, AF,
- not planned
CADD score, pleio,
- not planned
PhyloP score, ensembl VEP,
- Not planned
PhyloP score, AF,
- Not planned
PhyloP score, pleio,
- Not planned
ensembl VEP, AF,
- [x] Performed for rare common ratio
- [ ] change parser to only operate on SNPs, not other classes of variant
- [ ] fix parser, to split on `,N|`, not on just commas
    - [ ] Finish updating the associated drawio figure to demonstrate this
- [ ] repeat for AF, violin
ensembl VEP, pleio,
- not planned
AF, pleio
- not planned

### All possible three-variable plots:
malinois skew, malinois ref activity, CADD score,
- not planned
malinois skew, malinois ref activity, PhyloP score,
- [ ] do this. T-test difference of means for phylop conserved/nonconserved
malinois skew, malinois ref activity, ensembl VEP,
malinois skew, malinois ref activity, AF, <- **PRIORITY**
- Performed, with bins, & all genomic regions
- [ ] Continuious, 3D plot
- [ ] perform 3D regression (on abs skew)
- [ ] 2D slices (density plot?)
malinois skew, malinois ref activity, pleio,
- not planned
malinois skew, CADD score, PhyloP score,
- not planned
malinois skew, CADD score, ensembl VEP,
- not planned
malinois skew, CADD score, AF,
- not planned
malinois skew, CADD score, pleio,
- not planned
malinois skew, PhyloP score, ensembl VEP,
- not planned
malinois skew, PhyloP score, AF,
- not planned
malinois skew, PhyloP score, pleio,
- not planned
malinois skew, ensembl VEP, AF,
- not planned
malinois skew, ensembl VEP, pleio,
- not planned
malinois skew, AF, pleio,
- not planned
malinois ref activity, CADD score, PhyloP score,
- not planned
malinois ref activity, CADD score, ensembl VEP,
- not planned
malinois ref activity, CADD score, AF,
- not planned
malinois ref activity, CADD score, pleio,
- not planned
malinois ref activity, PhyloP score, ensembl VEP,
- not planned
malinois ref activity, PhyloP score, AF,
- not planned
malinois ref activity, PhyloP score, pleio,
- not planned
malinois ref activity, ensembl VEP, AF,
- not planned
malinois ref activity, ensembl VEP, pleio,
- not planned
malinois ref activity, AF, pleio,
- not planned
CADD score, PhyloP score, ensembl VEP,
- not planned
CADD score, PhyloP score, AF,
- not planned
CADD score, PhyloP score, pleio,
- not planned
CADD score, ensembl VEP, AF,
- not planned
CADD score, ensembl VEP, pleio,
- not planned
CADD score, AF, pleio,
- not planned
PhyloP score, ensembl VEP, AF,
- not planned
PhyloP score, ensembl VEP, pleio,
- not planned
PhyloP score, AF, pleio,
- not planned
ensembl VEP, AF, pleio
- not planned





misc. old completed tasks
- [x] Fix genotype number cutoff
- [x] annotated directly from GRCh38-cCREs.V4.bed.gz, make all types
    - [x] Get list of unique 
- [x] chr22 : Re-run annotate on chr 22 with fixed filtering parameters
    - [x] check if slurm can still write to output files in branches (it can't, let's just not track them)
- [~] crunch my way through the rest of the chromosomes
  - [x] rewrite to split by chromosome prior to annotation step. Then run that...
- [x] manually check annotations in IGV. 
- [x] filter for only intronic & intergenic vars prior to subsequent analysis
- [x] regraph
    - [x] modify to put . instead of - in the graphs
    - [x] fix thresholds

0. merge 
Adds malinouis predictions to datasets

1. annotate

2. count
Warning: cre_bool_columns is hardcoded

(interpretations)
CADD

>To simplify interpretation in some contexts, we also defined phred-like scores (scaled C  scores) on the basis of the rank of the C score of each variant relative  to all 8.6 billion possible SNVs, ranging from 1 to 99 (Supplementary  Note). For example, substitutions with the highest 10% (10−1) of all  scores—that is, those least likely to be observed human alleles under  our model—were assigned values of 10 or greater (‘≥C10’), whereas  variants  in  the  highest  1%  (10^−2),  0.1%  (10^−3),  etc.  were  assigned  scores ‘≥C20’, ‘≥C30’, etc

(A general framework for estimating the relative pathogenicity of human genetic variants, nature genetics, 2014)

PhyloP
- 

ensembl VEP
- 

Encode
https://screen.encodeproject.org/

>1. cCREs with promoter-like signatures (cCRE-PLS) fall within 200 bp (center to center) of an annotated GENCODE TSS and have high DNase and H3K4me3 signals (evaluated as DNase and H3K4me3 max-Z scores, defined as the maximal DNase or H3K4me3 Z scores across all biosamples with data; see Methods).
>2. cCREs with enhancer-like signatures (cCRE-ELS) have high DNase and H3K27ac max-Z scores and must additionally have a low H3K4me3 max-Z score if they are within 200 bp of an annotated TSS. The subset of cCREs-ELS within 2 kb of a TSS is denoted proximal (cCRE-pELS), while the remaining subset is denoted distal (cCRE-dELS).
>3. DNase-H3K4me3 cCREs have high H3K4me3 max-Z scores but low H3K27ac max-Z scores and do not fall within 200 bp of a TSS.
>4. CTCF-only cCREs have high DNase and CTCF max-Z scores and low H3K4me3 and H3K27ac max-Z scores. 
